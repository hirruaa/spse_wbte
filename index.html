<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÄ Studio v19 üéÄ</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Dancing+Script:wght@700&family=Pacifico&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root { --hot-pink: #ff85a1; --soft-pink: #ffe4e8; --text: #7d5a61; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Quicksand', sans-serif; background: #fff5f7; color: var(--text); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        
        .sidebar { width: 340px; background: white; padding: 20px; overflow-y: auto; z-index: 1000; transition: 0.4s; border-right: 1px solid var(--soft-pink); height: 100%; }
        #rightSidebar { border-right: none; border-left: 1px solid var(--soft-pink); width: 380px; }
        .sidebar.hidden { position: fixed; transform: translateX(-100%); }
        #rightSidebar.hidden { transform: translateX(100%); position: fixed; right: 0; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-x { font-size: 22px; cursor: pointer; color: var(--hot-pink); font-weight: bold; }

        .booth-side { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 20px; }

        /* Floating Triggers */
        .menu-trigger { position: fixed; top: 15px; font-size: 24px; background: white; border: 1px solid var(--soft-pink); width: 50px; height: 50px; border-radius: 12px; z-index: 900; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .menu-trigger.hidden { display: none; }

        /* Camera Box */
        .camera-wrapper { background: white; padding: 10px; border-radius: 24px; box-shadow: 0 15px 40px rgba(255,133,161,0.15); width: 100%; max-width: 480px; position: relative; }
        .camera-box { position: relative; width: 100%; aspect-ratio: 4 / 3; background: #000; border-radius: 16px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #ghostLayer { position: absolute; inset: 0; opacity: 0.25; pointer-events: none; transform: scaleX(-1); display: none; }

        /* Workspace */
        #previewContainer { background: #f0f0f0; border-radius: 12px; padding: 15px; text-align: center; cursor: crosshair; }
        #liveMaster { max-width: 100%; height: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; border-radius: 4px; }

        /* UI Styling */
        .card { background: #fff; border-radius: 15px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--soft-pink); }
        .pink-btn { background: var(--soft-pink); border: none; padding: 10px; border-radius: 10px; cursor: pointer; font: inherit; font-size: 11px; font-weight: 700; color: var(--text); width: 100%; margin-bottom: 5px; transition: 0.2s; }
        .pink-btn:hover { background: #fcd0d9; }
        .pink-btn.active { background: var(--hot-pink); color: white; }
        h4 { margin: 0 0 8px 0; font-size: 10px; text-transform: uppercase; color: var(--hot-pink); letter-spacing: 1px; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .m-content { background: white; width: 95%; max-width: 1000px; border-radius: 25px; padding: 25px; max-height: 90vh; overflow-y: auto; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 12px 30px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; z-index: 6000; pointer-events: none; border: 2px solid var(--hot-pink); }
        #flash { position: absolute; inset: 0; opacity: 0; pointer-events: none; z-index: 4000; background: white; }
    </style>
</head>
<body>

<div id="leftTrigger" class="menu-trigger" style="left:15px;" onclick="toggleSidebar('leftSidebar')">üé®</div>
<div id="rightTrigger" class="menu-trigger" style="right:15px;" onclick="toggleSidebar('rightSidebar')">üéûÔ∏è</div>
<button id="galBtn" class="menu-trigger" style="right:75px; font-size: 20px;" onclick="openGallery()">üìÇ</button>

<div id="toast">Saved to Gallery! ‚ú®</div>
<div id="flash"></div>

<div class="app-container">
    <aside id="leftSidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 style="color:var(--hot-pink); margin:0;">Edit Strip</h3>
            <div class="close-x" onclick="toggleSidebar('leftSidebar')">‚úï</div>
        </div>
        
        <div class="card">
            <h4>1. Filters</h4>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-bottom:8px;">
                <button class="pink-btn active" data-f="none" onclick="setF(this, 'none')">None</button>
                <button class="pink-btn" data-f="pink" onclick="setF(this, 'pink')">Glow</button>
                <button class="pink-btn" data-f="noir" onclick="setF(this, 'noir')">Noir</button>
                <button class="pink-btn" data-f="vint" onclick="setF(this, 'vint')">Vibe</button>
            </div>
            <input type="range" id="fInt" min="0" max="100" value="100" oninput="updateF()" style="width:100%;">
        </div>

        <div class="card">
            <h4>2. Layout</h4>
            <select id="lay" class="pink-btn" onchange="updateLivePreview()">
                <option value="strip">üéû Photo Strip</option>
                <option value="grid">üî≥ 2x2 Grid</option>
                <option value="polaroid">üì∏ Polaroid</option>
            </select>
        </div>

        <div class="card">
            <h4>3. Pattern & Opacity</h4>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:5px; margin-bottom:8px;">
                <button class="pink-btn active" data-p="white" onclick="setBG(this, 'white')">X</button>
                <button class="pink-btn" data-p="hearts" onclick="setBG(this, 'hearts')">üíï</button>
                <button class="pink-btn" data-p="stars" onclick="setBG(this, 'stars')">‚≠ê</button>
                <button class="pink-btn" data-p="check" onclick="setBG(this, 'check')">üèÅ</button>
            </div>
            <input type="range" id="bgOp" min="0" max="100" value="30" oninput="updateLivePreview()" style="width:100%;">
        </div>

        <div class="card">
            <h4>4. Text Styling</h4>
            <select id="fontF" class="pink-btn" onchange="updateLivePreview()">
                <option value="'Quicksand'">Modern</option>
                <option value="'Dancing Script'">Cursive</option>
                <option value="'Pacifico'">Retro</option>
                <option value="'Bebas Neue'">Bold</option>
            </select>
            <input type="text" id="endTxt" placeholder="Custom Message..." class="pink-btn" style="background:white; border:1px solid #ddd;" oninput="updateLivePreview()">
            <input type="color" id="txtCol" value="#ff85a1" oninput="updateLivePreview()" style="width:100%; height:30px; border:none; cursor:pointer;">
        </div>

        <button onclick="resetWorkspace()" class="pink-btn" style="background:#ffcbd1; margin-top:10px;">üóëÔ∏è CLEAR WORKSPACE</button>
    </aside>

    <main class="booth-side">
        <div class="camera-wrapper">
            <div class="camera-box">
                <video id="video" autoplay playsinline></video>
                <img id="ghostLayer">
                <div id="countdown" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:100px; color:white; font-weight:800; z-index:10; pointer-events:none; text-shadow: 0 0 20px rgba(0,0,0,0.5);"></div>
            </div>
        </div>
        <button id="snapBtn" style="background:var(--hot-pink); color:white; border:none; padding: 20px 60px; border-radius:50px; font-weight:800; margin-top:25px; cursor:pointer; font-size:20px; box-shadow: 0 10px 30px rgba(255,133,161,0.4); transition: 0.3s;">üì∏ CAPTURE</button>
        <p style="font-size:12px; color:#aaa; margin-top:15px;">Tip: Click a photo in the preview to retake it!</p>
    </main>

    <aside id="rightSidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 style="color:var(--hot-pink); margin:0;">Live Preview</h3>
            <div class="close-x" onclick="toggleSidebar('rightSidebar')">‚úï</div>
        </div>

        <div id="previewContainer">
            <canvas id="liveMaster" onclick="handleCanvasClick(event)"></canvas>
        </div>

        <button id="finalSave" class="pink-btn" style="background:var(--hot-pink); color:white; padding:15px; margin-top:15px; font-size:14px; display:none;">‚ú® SAVE STRIP</button>
    </aside>
</div>

<div id="galModal" class="modal">
    <div class="m-content">
        <div class="sidebar-header">
            <h2 style="color:var(--hot-pink); margin:0;">Photo Gallery</h2>
            <div class="close-x" onclick="closeGallery()">‚úï</div>
        </div>
        <div id="galGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:20px; margin-top:20px;"></div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const lmC = document.getElementById('liveMaster');
    const lmCtx = lmC.getContext('2d');
    const ghost = document.getElementById('ghostLayer');
    
    let activePhotos = [null, null, null, null], bgMode = 'white', activeID = null, fType = 'none';
    let gallery = JSON.parse(localStorage.getItem('studio_v19') || '[]');

    navigator.mediaDevices.getUserMedia({video: {aspectRatio: 4/3}}).then(s => { 
        video.srcObject = s; 
        updateLivePreview();
    });

    function toggleSidebar(id) {
        document.getElementById(id).classList.toggle('hidden');
        document.getElementById('leftTrigger').classList.toggle('hidden', !document.getElementById('leftSidebar').classList.contains('hidden'));
        document.getElementById('rightTrigger').classList.toggle('hidden', !document.getElementById('rightSidebar').classList.contains('hidden'));
    }

    function setF(btn, f) {
        document.querySelectorAll('[data-f]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); fType = f; updateF();
    }
    function updateF() {
        const v = document.getElementById('fInt').value / 100;
        video.style.filter = { none:'none', pink:`brightness(${1+0.1*v}) saturate(${1+0.5*v})`, noir:`grayscale(${v})`, vint:`sepia(${0.5*v})` }[fType];
    }
    function setBG(btn, p) {
        document.querySelectorAll('[data-p]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); bgMode = p; updateLivePreview();
    }

    let captureIndex = -1;
    document.getElementById('snapBtn').onclick = () => {
        captureIndex = activePhotos.findIndex(p => p === null);
        if(captureIndex === -1) return alert("Strip is full! Click a photo to replace.");
        startCountdown();
    };

    function startCountdown() {
        // Show Ghost Overlay if retaking
        if(activePhotos[captureIndex]) {
            ghost.src = activePhotos[captureIndex];
            ghost.style.display = 'block';
        }
        let count = 3;
        const el = document.getElementById('countdown');
        const t = setInterval(() => {
            el.innerText = count;
            if(count-- <= 0) { clearInterval(t); el.innerText = ""; snap(); }
        }, 1000);
    }

    function snap() {
        document.getElementById('flash').style.opacity = 1; setTimeout(()=>document.getElementById('flash').style.opacity=0, 100);
        const c = document.createElement('canvas'); c.width = 800; c.height = 600;
        const ctx = c.getContext('2d');
        ctx.filter = video.style.filter; ctx.translate(800,0); ctx.scale(-1,1);
        ctx.drawImage(video, 0, 0, 800, 600);
        activePhotos[captureIndex] = c.toDataURL('image/jpeg', 0.8);
        ghost.style.display = 'none';
        updateLivePreview();
    }

    function updateLivePreview() {
        const lay = document.getElementById('lay').value;
        const msg = document.getElementById('endTxt').value;
        const col = document.getElementById('txtCol').value;
        const font = document.getElementById('fontF').value;
        const op = document.getElementById('bgOp').value / 100;

        if(lay==='strip') { lmC.width=400; lmC.height=1400; }
        else if(lay==='grid') { lmC.width=800; lmC.height=900; }
        else { lmC.width=500; lmC.height=700; }

        lmCtx.fillStyle = "white"; lmCtx.fillRect(0,0,lmC.width,lmC.height);
        if(bgMode !== 'white') {
            lmCtx.globalAlpha = op; lmCtx.fillStyle = col; lmCtx.font = "24px serif";
            const chars = { hearts:'üíï', stars:'‚≠ê', check:'üèÅ' };
            for(let x=0; x<lmC.width; x+=50) for(let y=0; y<lmC.height; y+=50) lmCtx.fillText(chars[bgMode], x, y);
        }
        lmCtx.globalAlpha = 1;

        const total = (lay === 'polaroid' ? 1 : 4);
        let photoImages = [];
        for(let i=0; i<total; i++) {
            const src = activePhotos[i];
            let x, y, w=360, h=270;
            if(lay==='strip') { x=20; y=20+(i*320); }
            else if(lay==='grid') { x=20+(i%2)*390; y=20+Math.floor(i/2)*300; w=370; h=280; }
            else { x=25; y=25; w=450; h=337; }

            if(src) {
                const img = new Image(); img.src = src;
                photoImages.push(new Promise(res => {
                    img.onload = () => { lmCtx.drawImage(img, x, y, w, h); res(); };
                }));
            } else {
                lmCtx.fillStyle = "#f3f3f3"; lmCtx.fillRect(x,y,w,h);
                lmCtx.fillStyle = "#ccc"; lmCtx.font = "bold 14px sans-serif"; lmCtx.textAlign="center";
                lmCtx.fillText("READY", x+w/2, y+h/2);
            }
        }

        Promise.all(photoImages).then(() => {
            const footY = (lay === 'polaroid') ? 450 : lmC.height - 100;
            lmCtx.textAlign="center"; lmCtx.fillStyle = col;
            lmCtx.font = "bold 20px 'Quicksand'";
            lmCtx.fillText(new Date().toLocaleDateString(), lmC.width/2, footY);
            if(msg) { lmCtx.font = `italic 28px ${font}`; lmCtx.fillText(msg, lmC.width/2, footY + 45); }
        });

        const filledCount = activePhotos.filter((p,idx)=>idx<total && p!==null).length;
        document.getElementById('finalSave').style.display = (filledCount === total) ? 'block' : 'none';
    }

    function handleCanvasClick(e) {
        const rect = lmC.getBoundingClientRect();
        const scaleX = lmC.width / rect.width;
        const scaleY = lmC.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        const lay = document.getElementById('lay').value;

        if(lay === 'strip') captureIndex = Math.floor((y - 20) / 320);
        else if(lay === 'grid') captureIndex = (x < lmC.width/2 ? 0 : 1) + (y < 350 ? 0 : 2);
        else captureIndex = 0;

        if(captureIndex >= 0 && captureIndex < (lay==='polaroid'?1:4)) startCountdown();
    }

    document.getElementById('finalSave').onclick = () => {
        const item = { 
            id: activeID || Date.now(), 
            url: lmC.toDataURL('image/jpeg', 0.9), 
            raw: [...activePhotos], 
            lay: document.getElementById('lay').value, 
            msg: document.getElementById('endTxt').value, 
            col: document.getElementById('txtCol').value, 
            font: document.getElementById('fontF').value, 
            bg: bgMode 
        };
        if(activeID) gallery = gallery.filter(g => g.id !== activeID);
        gallery.unshift(item);
        localStorage.setItem('studio_v19', JSON.stringify(gallery.slice(0, 15)));
        showToast();
        resetWorkspace();
    };

    function resetWorkspace() {
        activePhotos = [null, null, null, null];
        activeID = null;
        document.getElementById('endTxt').value = "";
        updateLivePreview();
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2500);
    }

    function openGallery() {
        document.getElementById('galModal').style.display = 'flex';
        const grid = document.getElementById('galGrid');
        grid.innerHTML = '';
        gallery.forEach(g => {
            const d = document.createElement('div');
            d.className = 'card'; d.style.padding = '10px';
            d.innerHTML = `
                <img src="${g.url}" style="width:100%; border-radius:10px; margin-bottom:12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <button class="pink-btn" onclick="editSaved(${g.id})">Edit</button>
                    <a href="${g.url}" download="strip.jpg" class="pink-btn" style="text-align:center; text-decoration:none; background:var(--hot-pink); color:white;">Download</a>
                    <button class="pink-btn" style="grid-column: span 2; background:#ffcbd1" onclick="delSaved(${g.id})">Delete</button>
                </div>`;
            grid.appendChild(d);
        });
    }

    window.editSaved = (id) => {
        const g = gallery.find(x => x.id === id);
        activePhotos = [...g.raw]; 
        activeID = g.id;
        document.getElementById('lay').value = g.lay;
        document.getElementById('endTxt').value = g.msg;
        document.getElementById('txtCol').value = g.col;
        document.getElementById('fontF').value = g.font;
        bgMode = g.bg;
        closeGallery(); 
        updateLivePreview();
        if(document.getElementById('rightSidebar').classList.contains('hidden')) toggleSidebar('rightSidebar');
    };

    function closeGallery() { document.getElementById('galModal').style.display = 'none'; }
    window.delSaved = (id) => { gallery = gallery.filter(g => g.id !== id); localStorage.setItem('studio_v19', JSON.stringify(gallery)); openGallery(); };
</script>
</body>
</html>
