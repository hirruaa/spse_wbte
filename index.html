<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÄ Dreamy Studio Pro üéÄ</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --hot-pink: #ff85a1; --soft-pink: #ffe4e8; --accent: #fce4ec; --text: #7d5a61; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Quicksand', sans-serif; background: #fff5f7; color: var(--text); height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }

        /* --- Layout --- */
        .booth-side { flex: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .control-sidebar { width: 320px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; border-left: 2px solid var(--soft-pink); }
        .gallery-side { width: 350px; background: white; padding: 20px; overflow-y: auto; }

        /* --- Camera Area --- */
        .camera-wrapper { background: white; padding: 12px; border-radius: 35px; box-shadow: 0 15px 40px rgba(255,133,161,0.2); border: 4px solid var(--soft-pink); width: 95%; max-width: 500px; }
        .camera-box { position: relative; aspect-ratio: 4/3; background: #000; border-radius: 20px; overflow: hidden; cursor: move; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #liveCanvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* --- UI Controls --- */
        .card { background: white; border-radius: 18px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--soft-pink); }
        .card h4 { margin: 0 0 10px 0; font-size: 12px; color: var(--hot-pink); text-transform: uppercase; }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .pink-btn { background: var(--soft-pink); border: 2px solid transparent; padding: 8px; border-radius: 10px; cursor: pointer; font: inherit; font-size: 11px; font-weight: 700; transition: 0.2s; }
        .pink-btn.active { border-color: var(--hot-pink); background: var(--hot-pink); color: white; }
        
        input[type="range"] { width: 100%; accent-color: var(--hot-pink); margin-top: 5px; }
        .emoji-inp { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--soft-pink); margin-bottom: 5px; font-family: inherit; }

        /* --- Gallery --- */
        #gallery { width: 100%; }
        .strip-item { width: 100%; margin-bottom: 20px; position: relative; border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .strip-item img { width: 100%; display: block; }
        .del-btn { position: absolute; top: -10px; right: -10px; background: #ff4d6d; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; z-index: 5; }

        /* --- Overlays --- */
        #settingsIcon { position: absolute; top: 15px; left: 15px; background: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; font-size: 20px; }
        #flash { position: absolute; inset: 0; opacity: 0; pointer-events: none; z-index: 1000; }
        #countdown { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 80px; color: white; font-weight: 900; z-index: 1001; pointer-events: none; }

        @media (max-width: 1024px) {
            .app-container { flex-direction: column; overflow-y: auto; }
            .booth-side { flex: none; padding: 70px 10px 20px; }
            .control-sidebar { width: 100%; border: none; display: flex; overflow-x: auto; gap: 10px; }
            .card { min-width: 280px; margin-bottom: 0; }
            .gallery-side { width: 100%; }
        }
    </style>
</head>
<body>

<div id="settingsIcon">‚öôÔ∏è</div>
<div id="flash"></div>

<div class="app-container">
    <main class="booth-side">
        <div class="camera-wrapper">
            <div class="camera-box" id="dragZone">
                <video id="video" autoplay playsinline></video>
                <canvas id="liveCanvas"></canvas>
                <div id="countdown"></div>
            </div>
        </div>
        <button id="startBtn" style="background:var(--hot-pink); color:white; border:none; padding: 15px 40px; border-radius:50px; font-weight:bold; margin-top:20px; cursor:pointer;">üì∏ TAKE PHOTOS</button>
    </main>

    <aside class="control-sidebar">
        <div class="card">
            <h4>Filters & Intensity</h4>
            <div class="btn-grid">
                <button class="pink-btn active" data-type="filter" onclick="setF(this, 'none')">None</button>
                <button class="pink-btn" data-type="filter" onclick="setF(this, 'pink')">Glow</button>
                <button class="pink-btn" data-type="filter" onclick="setF(this, 'noir')">Noir</button>
                <button class="pink-btn" data-type="filter" onclick="setF(this, 'warm')">Warm</button>
                <button class="pink-btn" data-type="filter" onclick="setF(this, 'cold')">Ice</button>
                <button class="pink-btn" data-type="filter" onclick="setF(this, 'vintage')">Vibe</button>
            </div>
            <input type="range" id="fInt" min="0" max="200" value="100" oninput="updateF()">
        </div>

        <div class="card">
            <h4>Add Emojis / Text</h4>
            <input type="text" id="emojiInp" class="emoji-inp" placeholder="Type emoji or text...">
            <button class="pink-btn" style="width:100%" onclick="addCustomS()">‚ú® Add to Mirror</button>
            <p style="font-size:9px; color:#aaa; margin-top:5px;">Scroll mouse or use slider below to resize selected</p>
            <input type="range" id="sizeRange" min="20" max="200" value="80" oninput="resizeS(this.value)">
        </div>

        <div class="card">
            <h4>Patterns</h4>
            <div class="btn-grid">
                <button class="pink-btn active" data-type="pattern" onclick="setP(this, 'white')">White</button>
                <button class="pink-btn" data-type="pattern" onclick="setP(this, 'hearts')">üíï</button>
                <button class="pink-btn" data-type="pattern" onclick="setP(this, 'dots')">‚ö™</button>
                <button class="pink-btn" data-type="pattern" onclick="setP(this, 'stars')">‚≠ê</button>
                <button class="pink-btn" data-type="pattern" onclick="setP(this, 'check')">üèÅ</button>
                <button class="pink-btn" style="background:#ffcdd2" onclick="stickers=[]">Clear Stickers</button>
            </div>
        </div>
    </aside>

    <aside class="gallery-side">
        <h3>Memory Gallery</h3>
        <div id="gallery"></div>
    </aside>
</div>

<div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:white; padding:30px; border-radius:25px; width:320px; text-align:center;">
        <h3>Layout Settings</h3>
        <select id="laySelect" class="pink-btn" style="width:100%; margin:10px 0;">
            <option value="strip">üéû Classic Strip</option>
            <option value="polaroid">üì∏ Retro Polaroid</option>
            <option value="grid">üî≥ 2x2 Grid</option>
        </select>
        <input type="text" id="customLabel" placeholder="Custom text (optional)" class="pink-btn" style="width:100%; margin:10px 0; background:white; border:1px solid #eee;">
        <button onclick="document.getElementById('modal').style.display='none'" class="pink-btn" style="background:var(--hot-pink); color:white; width:100%;">Save</button>
    </div>
</div>

<canvas id="master" hidden></canvas>

<script>
    const video = document.getElementById('video');
    const liveC = document.getElementById('liveCanvas');
    const lCtx = liveC.getContext('2d');
    const dragZone = document.getElementById('dragZone');
    
    let stickers = [], bgMode = 'white', fType = 'none', fVal = 100, activeS = null;

    navigator.mediaDevices.getUserMedia({video: true}).then(s => {
        video.srcObject = s;
        liveC.width = 800; liveC.height = 600;
        animate();
        loadHistory();
    });

    // --- Emoji & Dragging ---
    function addCustomS() {
        const val = document.getElementById('emojiInp').value;
        if(val) { stickers.push({ text: val, x: 400, y: 300, s: 80 }); document.getElementById('emojiInp').value = ''; }
    }

    function getCoords(e) {
        const rect = dragZone.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (cx - rect.left) * (800 / rect.width), y: (cy - rect.top) * (600 / rect.height) };
    }

    dragZone.addEventListener('mousedown', (e) => activeS = findS(getCoords(e)));
    dragZone.addEventListener('touchstart', (e) => { activeS = findS(getCoords(e)); if(activeS) e.preventDefault(); }, {passive:false});
    window.addEventListener('mousemove', (e) => { if(activeS) { const p = getCoords(e); activeS.x = p.x; activeS.y = p.y; } });
    window.addEventListener('touchmove', (e) => { if(activeS) { e.preventDefault(); const p = getCoords(e); activeS.x = p.x; activeS.y = p.y; } }, {passive:false});
    window.addEventListener('mouseup', () => activeS = null);
    window.addEventListener('touchend', () => activeS = null);
    
    // PC Scroll Resizing
    dragZone.addEventListener('wheel', (e) => {
        if(activeS) { e.preventDefault(); activeS.s = Math.max(20, activeS.s + (e.deltaY > 0 ? -10 : 10)); }
    }, {passive:false});

    function resizeS(val) { if(activeS) activeS.s = parseInt(val); }
    function findS(p) { return [...stickers].reverse().find(s => Math.hypot(s.x - p.x, (s.y-30) - p.y) < 60); }

    function animate() {
        lCtx.clearRect(0,0,800,600);
        lCtx.textAlign = "center";
        stickers.forEach(s => {
            lCtx.font = `${s.s}px serif`;
            lCtx.fillText(s.text, s.x, s.y);
            if(s === activeS) { lCtx.strokeStyle = "#ff85a1"; lCtx.lineWidth=3; lCtx.strokeRect(s.x-s.s/2, s.y-s.s, s.s, s.s); }
        });
        requestAnimationFrame(animate);
    }

    // --- Filters ---
    function setF(btn, f) {
        document.querySelectorAll('[data-type="filter"]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); fType = f; updateF();
    }
    function updateF() {
        fVal = document.getElementById('fInt').value / 100;
        const filters = {
            none: 'none',
            pink: `brightness(${1+0.1*fVal}) saturate(${1+0.5*fVal}) hue-rotate(-10deg)`,
            noir: `grayscale(${fVal}) contrast(1.2)`,
            warm: `sepia(${0.5*fVal}) saturate(1.2)`,
            cold: `hue-rotate(180deg) saturate(${fVal})`,
            vintage: `contrast(0.8) sepia(0.3) brightness(1.1)`
        };
        video.style.filter = filters[fType];
    }
    function setP(btn, p) { document.querySelectorAll('[data-type="pattern"]').forEach(b => b.classList.remove('active')); btn.classList.add('active'); bgMode = p; }

    // --- Capture ---
    document.getElementById('startBtn').onclick = async () => {
        const layout = document.getElementById('laySelect').value;
        const count = layout === 'polaroid' ? 1 : 4;
        const frames = [];
        for(let i=0; i<count; i++) {
            await (new Promise(r => {
                let c = 3; const el = document.getElementById('countdown');
                const t = setInterval(() => { el.innerText = c; if(c-- <= 0) { clearInterval(t); el.innerText=""; r(); } }, 1000);
            }));
            frames.push(snap());
        }
        drawFinal(frames, layout);
    };

    function snap() {
        const flash = document.getElementById('flash'); flash.style.opacity = 1; setTimeout(()=>flash.style.opacity=0, 150);
        const c = document.createElement('canvas'); c.width = 800; c.height = 600;
        const ctx = c.getContext('2d');
        ctx.filter = video.style.filter; ctx.translate(800,0); ctx.scale(-1,1);
        const sw = video.videoHeight * (4/3);
        ctx.drawImage(video, (video.videoWidth-sw)/2, 0, sw, video.videoHeight, 0, 0, 800, 600);
        ctx.scale(-1,1); ctx.translate(-800,0);
        stickers.forEach(s => { ctx.font = `${s.s}px serif`; ctx.textAlign="center"; ctx.fillText(s.text, s.x, s.y); });
        return c.toDataURL();
    }

    function drawFinal(photos, type) {
        const m = document.getElementById('master'); const ctx = m.getContext('2d');
        const custom = document.getElementById('customLabel').value;
        const dateStr = new Date().toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const labelText = custom ? `${custom} | ${dateStr}` : dateStr;

        if(type === 'strip') { m.width = 440; m.height = 1450; }
        else if(type === 'polaroid') { m.width = 600; m.height = 820; }
        else { m.width = 860; m.height = 850; }

        ctx.fillStyle = "white"; ctx.fillRect(0,0,m.width,m.height);

        // Pattern
        if(bgMode !== 'white') {
            ctx.fillStyle = "#fff0f3"; ctx.font = "24px serif";
            const chars = { hearts:'üíï', dots:'‚óè', stars:'‚≠ê', check:'üèÅ' };
            for(let x=0; x<m.width; x+=50) for(let y=0; y<m.height; y+=50) ctx.fillText(chars[bgMode], x, y);
        }

        photos.forEach((p, i) => {
            const img = new Image(); img.src = p;
            img.onload = () => {
                if(type === 'strip') ctx.drawImage(img, 20, 20 + (i*340), 400, 300);
                else if(type === 'polaroid') ctx.drawImage(img, 25, 25, 550, 412);
                else ctx.drawImage(img, 20 + (i%2)*420, 20 + Math.floor(i/2)*320, 400, 300);
                
                if(i === photos.length-1) {
                    // Visible Date Box
                    ctx.fillStyle = "white"; 
                    const boxW = ctx.measureText(labelText).width + 40;
                    ctx.fillRect(m.width/2 - boxW/2, m.height - 80, boxW, 50);
                    ctx.strokeStyle = "#ff85a1"; ctx.lineWidth = 2; ctx.strokeRect(m.width/2 - boxW/2, m.height - 80, boxW, 50);
                    
                    ctx.fillStyle = "#ff85a1"; ctx.font = "bold 20px Quicksand"; ctx.textAlign = "center";
                    ctx.fillText(labelText, m.width/2, m.height - 47);
                    
                    const url = m.toDataURL();
                    addGal(url); saveLoc(url);
                }
            };
        });
    }

    function addGal(u) {
        const div = document.createElement('div'); div.className = "strip-item";
        div.innerHTML = `<button class="del-btn" onclick="del('${u}', this)">√ó</button><img src="${u}"><div style="display:flex;gap:5px;padding:5px">
            <button class="pink-btn" style="flex:1" onclick="shareImg('${u}')">Share</button>
            <a href="${u}" download="studio.png" class="pink-btn" style="flex:1;text-decoration:none;text-align:center;">Save</a></div>`;
        document.getElementById('gallery').prepend(div);
    }

    window.del = (u, b) => { b.parentElement.remove(); let h = JSON.parse(localStorage.getItem('studio_v5')||'[]'); localStorage.setItem('studio_v5', JSON.stringify(h.filter(x => x !== u))); };
    window.shareImg = async (u) => { const b = await (await fetch(u)).blob(); const f = new File([b], 'photo.png', {type:'image/png'}); if(navigator.share) navigator.share({files:[f]}); };
    function saveLoc(u) { let h = JSON.parse(localStorage.getItem('studio_v5')||'[]'); h.unshift(u); localStorage.setItem('studio_v5', JSON.stringify(h.slice(0,10))); }
    function loadHistory() { let h = JSON.parse(localStorage.getItem('studio_v5')||'[]'); h.forEach(u => addGal(u)); }
    document.getElementById('settingsIcon').onclick = () => document.getElementById('modal').style.display='flex';
</script>
</body>
</html>
