<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digital Photobooth</title>

<style>
:root {
    --bg: #1a1a2e;
    --card: #16213e;
    --accent: #e94560;
    --text: #ffffff;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
}

.app-container { display: flex; height: 100vh; }

/* ================= SETTINGS ================= */
#settingsBtn {
    position: fixed;
    left: 12px;
    top: 12px;
    z-index: 1000;
    background: var(--card);
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 20px;
    cursor: pointer;
}

#settingsPanel {
    position: fixed;
    top: 0;
    left: -220px;
    width: 200px;
    height: 100%;
    background: var(--card);
    padding: 20px;
    transition: left 0.3s ease;
    z-index: 999;
}

#settingsPanel.open { left: 0; }

#settingsPanel h3 { margin-top: 60px; margin-bottom: 15px; }

#settingsPanel button {
    width: 100%;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: #222;
    color: white;
    cursor: pointer;
}

#settingsPanel button.active { background: var(--accent); }

/* ================= BOOTH ================= */
.booth-side {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
}

header { text-align: center; margin-bottom: 10px; }

.camera-box {
    position: relative;
    width: 100%;
    max-width: 640px;
    aspect-ratio: 4 / 3;
    background: black;
    border: 6px solid white;
    overflow: hidden;
}

video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

#flash {
    position: absolute;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
}

.flash-trigger { animation: flash 0.4s; }
@keyframes flash { from { opacity: 1; } to { opacity: 0; } }

#countdown {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(60px, 15vw, 120px);
    font-weight: bold;
}

.controls {
    margin-top: 15px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
}

.control-group { display: flex; flex-direction: column; font-size: 14px; }

select { padding: 8px; border-radius: 6px; }

#startBtn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 14px 36px;
    border-radius: 30px;
    font-size: 18px;
    cursor: pointer;
}

#startBtn:disabled { opacity: 0.6; cursor: not-allowed; }

/* ================= GALLERY ================= */
.gallery-side {
    width: 350px;
    background: var(--card);
    padding: 20px;
    overflow-y: auto;
}

.strip-container {
    background: white;
    padding: 10px;
    margin-bottom: 20px;
    color: black;
}

.strip-container img { width: 100%; display: block; margin-bottom: 8px; }
.strip-container a, .strip-container button { margin-right: 6px; }

/* ================= MOBILE ================= */
@media (max-width: 768px) {
    .app-container { flex-direction: column; }
    .gallery-side { width: 100%; order: 2; }
    .booth-side { order: 1; }
    .controls { flex-direction: column; width: 100%; }
    #startBtn { width: 100%; max-width: 300px; }
}
</style>
</head>

<body>
<button id="settingsBtn" aria-label="Camera Settings">‚öôÔ∏è</button>

<div id="settingsPanel">
    <h3>Camera Size</h3>
    <button data-ratio="1:1">‚¨õ Square</button>
    <button data-ratio="3:4">üì± Portrait</button>
    <button data-ratio="4:3" class="active">üñ• Landscape</button>

    <h3>Filter</h3>
    <select id="filterSelect">
        <option value="none">Normal</option>
        <option value="grayscale(100%)">Noir (B&W)</option>
        <option value="sepia(100%)">Vintage</option>
        <option value="brightness(1.4) saturate(1.2)">Pop Art</option>
        <option value="hue-rotate(180deg)">Dreamy</option>
    </select>
</div>

<div class="app-container">
    <main class="booth-side">
        <header>
            <h1>PHOTOBOOTH</h1>
            <p>Strike a pose for 4 photos!</p>
        </header>

        <div class="camera-box">
            <video id="video" autoplay playsinline></video>
            <div id="countdown"></div>
            <div id="flash"></div>
        </div>

        <div class="controls">
            <button id="startBtn">CAPTURE</button>
        </div>
    </main>

    <aside class="gallery-side">
        <h2>Your Strips</h2>
        <div id="gallery"><p class="empty-msg">No photos yet. Start a session!</p></div>
    </aside>
</div>

<canvas id="masterCanvas" hidden></canvas>
<audio id="shutterSound" src="shutter.mp3" preload="auto"></audio>

<script>
const PHOTO_COUNT = 4;
const PHOTO_WIDTH = 400;
const PHOTO_HEIGHT = 300;
const PADDING = 20;

const video = document.getElementById("video");
const startBtn = document.getElementById("startBtn");
const gallery = document.getElementById("gallery");
const masterCanvas = document.getElementById("masterCanvas");
const shutter = document.getElementById("shutterSound");
const countdownEl = document.getElementById("countdown");
const flashEl = document.getElementById("flash");
const filterSelect = document.getElementById("filterSelect");

const settingsBtn = document.getElementById("settingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const ratioButtons = settingsPanel.querySelectorAll("button[data-ratio]");
const cameraBox = document.querySelector(".camera-box");

let captures = [];
let isCapturing = false;
let currentRatio = "4:3";

/* ================= CAMERA ================= */
async function initCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();
    } catch {
        alert("Camera access denied or unavailable.");
    }
}

/* ================= SETTINGS ================= */
settingsBtn.onclick = () => settingsPanel.classList.toggle("open");

ratioButtons.forEach(btn => {
    btn.onclick = () => {
        ratioButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        currentRatio = btn.dataset.ratio;
        if (currentRatio === "1:1") cameraBox.style.aspectRatio = "1 / 1";
        if (currentRatio === "3:4") cameraBox.style.aspectRatio = "3 / 4";
        if (currentRatio === "4:3") cameraBox.style.aspectRatio = "4 / 3";
    };
});

/* ================= FILTER ================= */
filterSelect.value = "none";
video.style.filter = filterSelect.value;
filterSelect.onchange = () => video.style.filter = filterSelect.value;

/* ================= CAPTURE FLOW ================= */
startBtn.onclick = async () => {
    if (isCapturing) return;

    isCapturing = true;
    startBtn.disabled = true;
    filterSelect.disabled = true;
    captures = [];
    document.querySelector(".empty-msg")?.remove();

    for (let i = 0; i < PHOTO_COUNT; i++) {
        await countdown(3);
        snap();
    }

    buildStrip();

    startBtn.disabled = false;
    filterSelect.disabled = false;
    isCapturing = false;
};

function countdown(sec) {
    return new Promise(res => {
        let c = sec;
        countdownEl.textContent = c;
        const t = setInterval(() => {
            c--;
            if (c > 0) countdownEl.textContent = c;
            else { clearInterval(t); countdownEl.textContent = ""; res(); }
        }, 1000);
    });
}

/* ================= SNAP FUNCTION ‚Äî CROPPED CAPTURE ================= */
function snap() {
    flashEl.classList.add("flash-trigger");
    setTimeout(() => flashEl.classList.remove("flash-trigger"), 400);

    shutter.currentTime = 0;
    shutter.play().catch(() => {});

    const videoW = video.videoWidth;
    const videoH = video.videoHeight;

    let targetRatio = 4 / 3;
    if (currentRatio === "1:1") targetRatio = 1;
    if (currentRatio === "3:4") targetRatio = 3 / 4;

    const videoRatio = videoW / videoH;
    let sx, sy, sw, sh;

    if (videoRatio > targetRatio) {
        sh = videoH;
        sw = videoH * targetRatio;
        sx = (videoW - sw) / 2;
        sy = 0;
    } else {
        sw = videoW;
        sh = videoW / targetRatio;
        sx = 0;
        sy = (videoH - sh) / 2;
    }

    const canvas = document.createElement("canvas");
    canvas.width = sw;
    canvas.height = sh;
    const ctx = canvas.getContext("2d");
    ctx.filter = filterSelect.value;

    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

    captures.push(canvas.toDataURL("image/png"));
}

/* ================= BUILD STRIP ================= */
function buildStrip() {
    const ctx = masterCanvas.getContext("2d");
    masterCanvas.width = PHOTO_WIDTH + PADDING * 2;
    masterCanvas.height = PHOTO_HEIGHT * PHOTO_COUNT + PADDING * (PHOTO_COUNT + 1);

    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, masterCanvas.width, masterCanvas.height);

    let loaded = 0;
    captures.forEach((src, i) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            ctx.drawImage(img, PADDING, PADDING + i * (PHOTO_HEIGHT + PADDING), PHOTO_WIDTH, PHOTO_HEIGHT);
            if (++loaded === captures.length) addToGallery();
        };
    });
}

function addToGallery() {
    const url = masterCanvas.toDataURL("image/png");
    const div = document.createElement("div");
    div.className = "strip-container";
    div.innerHTML = `
        <img src="${url}">
        <a href="${url}" download="photobooth-strip.png">Download</a>
        <button onclick="window.print()">Print</button>
    `;
    gallery.prepend(div);
}

/* ================= INIT ================= */
initCamera();
</script>

</body>
</html>
